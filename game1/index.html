<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zone 13 | Flat Demo v1 (Store Glow)</title>
  <style>
    :root{
      --bg:#070b0e;
      --panel:#0d141a;
      --panel2:#0a1015;
      --border:#1b2a33;
      --ink:#d6dee6;
      --muted:#8ea0ad;
      --good:#22c55e;
      --warn:#eab308;
      --bad:#ef4444;
      --cyan:#22d3ee;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .app{height:100%;display:grid;grid-template-columns:360px 1fr 420px;gap:12px;padding:12px;}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px;overflow:hidden;}
    .panel h2{margin:0 0 10px 0;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-variant-numeric:tabular-nums;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.06);}
    .row:last-child{border-bottom:none;}
    .k{font-size:12px;color:var(--muted);}
    .v{font-size:13px;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px;}
    .pill.good{color:var(--good);border-color:rgba(34,197,94,.35);}
    .pill.warn{color:var(--warn);border-color:rgba(234,179,8,.35);}
    .pill.bad{color:var(--bad);border-color:rgba(239,68,68,.35);}
    .pill.cyan{color:var(--cyan);border-color:rgba(34,211,238,.35);}
    button{
      background:#0a1116;border:1px solid var(--border);color:var(--ink);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px;
    }
    button:hover{border-color:rgba(34,211,238,.45);color:var(--cyan);}
    button[disabled]{opacity:.45;cursor:not-allowed;}
    .glow{
      box-shadow:0 0 0 2px rgba(34,211,238,.08), 0 0 18px rgba(34,211,238,.18);
      border-color:rgba(34,211,238,.35);
    }

    .center{display:grid;grid-template-rows:auto 1fr;gap:12px;min-width:0;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{display:flex;flex-direction:column;gap:2px;}
    .brand .title{font-size:13px;letter-spacing:.08em;text-transform:uppercase;color:#b9c8d4;}
    .brand .sub{font-size:12px;color:var(--muted);}
    .tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel2);font-size:12px;color:#cfe0ee;}

    .map{
      background:linear-gradient(180deg, rgba(34,211,238,.04), rgba(0,0,0,0));
      border:1px solid var(--border);border-radius:14px;
      position:relative;overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      min-height:520px;
    }
    .gridWrap{position:relative; width:min(920px, 100%); height:560px; padding:18px;}
    .grid{
      display:grid;
      grid-template-columns:repeat(12, 56px);
      grid-template-rows:repeat(9, 56px);
      gap:10px;
      justify-content:center;
      align-content:center;
      user-select:none;
    }
    .tile{
      width:56px;height:56px;border-radius:12px;
      background:#0a1116;
      border:1px solid rgba(255,255,255,.09);
      position:relative;
      cursor:pointer;
    }
    .tile:hover{border-color:rgba(34,211,238,.22);}
    .tile.occupied{cursor:pointer;}
    .bldg{
      position:absolute; inset:6px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(9,16,22,.75);
      display:flex;align-items:center;justify-content:center;
      text-align:center;
      padding:4px;
    }
    .bldg .name{font-size:10px;letter-spacing:.06em;text-transform:uppercase;color:#cfe0ee;line-height:1.1;}
    .bldg .state{margin-top:3px;font-size:10px;color:var(--muted);}
    .bldg.online{border-color:rgba(34,197,94,.35);}
    .bldg.offline{border-color:rgba(239,68,68,.28);}
    .bldg.fuel{border-color:rgba(34,211,238,.25);}
    .bldg.life{border-color:rgba(168,85,247,.22);}
    .bldg.gen{border-color:rgba(234,179,8,.18);}

    .toasts{
      position:absolute;right:16px;bottom:16px;
      display:flex;flex-direction:column;gap:8px;
      z-index:50;
      pointer-events:none;
      width:min(380px, 92vw);
    }
    .toast{
      pointer-events:none;
      background:rgba(9,16,22,.86);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 14px 28px rgba(0,0,0,.35);
      transform:translateY(6px);
      opacity:0;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1;transform:translateY(0);}
    .toast .t{font-size:12px;color:#d7e3ec;margin-bottom:3px;}
    .toast .b{font-size:12px;color:var(--muted);line-height:1.35;}
    .toast.good{border-color:rgba(34,197,94,.22);}
    .toast.warn{border-color:rgba(234,179,8,.22);}
    .toast.bad{border-color:rgba(239,68,68,.22);}
    .toast.cyan{border-color:rgba(34,211,238,.22);}

    .right{display:flex;flex-direction:column;gap:12px;min-width:0;}
    .storeHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .storeMoney{font-size:12px;color:#b9c8d4;}
    .item{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin-top:8px;
    }
    .itemTitle{font-size:13px;}
    .itemMeta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35;}
    .itemRight{display:flex;flex-direction:column;align-items:flex-end;gap:6px;}
    .cost{font-size:12px;color:#cfe0ee;}
    .log{
      flex:1;min-height:160px;
      background:#070c10;border:1px solid var(--border);border-radius:12px;
      padding:10px;overflow:auto;white-space:pre-wrap;
      font-size:12px;line-height:1.35;color:#c6d3de;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    }

    .splash{
      position:fixed; inset:0;
      background:rgba(0,0,0,.72);
      display:flex;align-items:center;justify-content:center;
      z-index:200;
      padding:18px;
    }
    .card{
      width:min(760px, 96vw);
      background:rgba(9,16,22,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      box-shadow:0 24px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .card h1{
      margin:0 0 8px 0;
      font-size:14px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#cfe0ee;
    }
    .card p{margin:0 0 10px 0;font-size:12px;color:var(--muted);line-height:1.45;}
    .card .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}
    .kbd{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(10,16,21,.8);font-size:11px;color:#cfe0ee;}

    @media (max-width: 980px){
      .app{grid-template-columns:1fr;}
      .grid{grid-template-columns:repeat(10, 52px);grid-template-rows:repeat(10, 52px);gap:8px;}
      .tile{width:52px;height:52px;}
    }
  </style>
</head>
<body>

<!-- Splash -->
<div class="splash" id="splash">
  <div class="card">
    <h1>ZONE 13 - STABILIZATION DEMO</h1>
    <p>
      Bring the zone online in the correct order. Once Life Support is online, the Store will highlight the next step.
    </p>
    <p class="mono" style="margin-top:6px;">
      Goal (Demo): Generator ONLINE → Life Support ONLINE → Buy Fuel Station → Fuel starts producing.
    </p>
    <div class="actions">
      <span class="kbd">Click buildings to toggle</span>
      <button id="btnOk">OK, START</button>
    </div>
  </div>
</div>

<div class="app">
  <!-- LEFT HUD -->
  <section class="panel">
    <h2>HUD</h2>

    <div class="row"><div class="k">Tick</div><div class="v mono" id="hudTick">0</div></div>

    <div class="row">
      <div class="k">System</div>
      <div class="v"><span class="pill bad" id="hudSystem">OFFLINE</span></div>
    </div>

    <div class="row">
      <div class="k">Power</div>
      <div class="v">
        <span class="pill bad" id="hudPowerState">RED</span>
        <span class="mono" id="hudPowerNums">(0.0 / 0.0)</span>
      </div>
    </div>

    <div class="row"><div class="k">Population</div><div class="v mono" id="hudPop">0</div></div>

    <div class="row">
      <div class="k">Happiness</div>
      <div class="v"><span class="pill warn" id="hudHappyState">NEUTRAL</span> <span class="mono" id="hudHappy">50</span></div>
    </div>

    <div class="row"><div class="k">Money</div><div class="v mono" id="hudMoney">50.00</div></div>

    <div class="row"><div class="k">Fuel</div><div class="v mono" id="hudFuel">0.000</div></div>

    <div class="row">
      <div class="k">Life Support</div>
      <div class="v"><span class="pill bad" id="hudLife">OFFLINE</span></div>
    </div>

    <div class="row">
      <div class="k">Fuel Station</div>
      <div class="v"><span class="pill bad" id="hudFuelStation">OFFLINE</span></div>
    </div>

    <div class="row" style="border-bottom:none;">
      <div class="k">Note</div>
      <div class="v" style="font-size:12px;color:var(--muted);">
        Store glows once Life Support is ON.
      </div>
    </div>
  </section>

  <!-- CENTER -->
  <section class="center">
    <div class="panel topbar">
      <div class="brand">
        <div class="title">Zone 13</div>
        <div class="sub">Flat Demo v1 • Store Glow • Start Money = 50</div>
      </div>
      <div class="tools">
        <button id="btnStart">Start</button>
        <button id="btnPause">Pause</button>
        <button id="btnStep">Step Tick</button>
        <button id="btnReset">Reset</button>
        <span class="chip mono">No isometric. No cables. Just loop.</span>
      </div>
    </div>

    <div class="map panel">
      <div class="gridWrap">
        <div class="grid" id="grid"></div>
        <div class="toasts" id="toasts"></div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="right">
    <div class="panel" id="storePanel">
      <div class="storeHeader">
        <h2 style="margin:0;">Store</h2>
        <div class="storeMoney">Available: <span class="mono" id="storeMoney">50.00</span></div>
      </div>

      <div class="item">
        <div>
          <div class="itemTitle">Fuel Station</div>
          <div class="itemMeta">
            Produces fuel when the grid is not RED.<br/>
            <span class="mono">Demo behavior:</span> buying auto-places it for you.
          </div>
        </div>
        <div class="itemRight">
          <div class="cost">Cost: <span class="mono" id="fuelCost">30</span></div>
          <button id="btnBuyFuel" disabled>Locked</button>
        </div>
      </div>

      <div class="item">
        <div>
          <div class="itemTitle">Coming Soon</div>
          <div class="itemMeta">Food • Water • Tech • Events (later)</div>
        </div>
        <div class="itemRight">
          <div class="cost">—</div>
          <button disabled>—</button>
        </div>
      </div>
    </div>

    <div class="panel" style="display:flex;flex-direction:column;gap:10px;min-height:240px;">
      <h2>Debug Log</h2>
      <div class="log" id="log"></div>
    </div>
  </section>
</div>

<script>
(() => {
  // ====== TUNABLES (this is the exact flat demo baseline) ======
  const GRID_W = 12, GRID_H = 9;

  const START_MONEY = 50;
  const FUEL_STATION_COST = 30;

  const GEN_SUPPLY = 4.0;
  const LIFE_DEMAND = 1.0;
  const FUEL_DEMAND = 1.0;

  const STARTER_FUEL = 0.80;
  const FUEL_PROD_PER_TICK = 0.10;     // fuel station output
  const GEN_BURN_PER_TICK = 0.05;      // generator burn

  const POP_SEED = 12;                 // arrives once system online
  const TAX_PER_POP_PER_TICK = 0.03;   // money engine

  const POS_GEN  = {x:3, y:3};
  const POS_LIFE = {x:5, y:3};
  const POS_FUEL_AUTO = {x:4, y:5};    // demo-only auto placement

  let timer = null;

  // ====== STATE ======
  const state = {
    tick: 0,
    money: START_MONEY,
    fuel: 0,
    pop: 0,
    happy: 50,

    buildings: new Map(), // key "x,y" -> {type,name,online}
    unlockedFuel: false,
    boughtFuel: false,
    placedFuel: false,

    power: { supply:0, demand:0, state:"RED" }
  };

  // ====== DOM ======
  const el = {
    splash: q("#splash"),
    btnOk: q("#btnOk"),

    grid: q("#grid"),
    toasts: q("#toasts"),

    hudTick: q("#hudTick"),
    hudSystem: q("#hudSystem"),
    hudPowerState: q("#hudPowerState"),
    hudPowerNums: q("#hudPowerNums"),
    hudPop: q("#hudPop"),
    hudHappyState: q("#hudHappyState"),
    hudHappy: q("#hudHappy"),
    hudMoney: q("#hudMoney"),
    hudFuel: q("#hudFuel"),
    hudLife: q("#hudLife"),
    hudFuelStation: q("#hudFuelStation"),

    storePanel: q("#storePanel"),
    storeMoney: q("#storeMoney"),
    btnBuyFuel: q("#btnBuyFuel"),

    btnStart: q("#btnStart"),
    btnPause: q("#btnPause"),
    btnStep: q("#btnStep"),
    btnReset: q("#btnReset"),

    log: q("#log"),
  };

  // ====== INIT ======
  buildGrid();
  placeInitial();
  renderAll();
  log("Loaded: Flat Demo v1 baseline.");

  // Splash
  el.btnOk.addEventListener("click", () => {
    el.splash.style.display = "none";
    toast("READY", "Click the Generator, then Life Support. Store will glow.", "cyan");
  });

  // Controls
  el.btnStart.addEventListener("click", start);
  el.btnPause.addEventListener("click", pause);
  el.btnStep.addEventListener("click", stepTick);
  el.btnReset.addEventListener("click", reset);

  // Store
  el.btnBuyFuel.addEventListener("click", buyFuel);

  // ====== CORE LOOP ======
  function start(){
    if (timer) return;
    timer = setInterval(stepTick, 1000);
    log("ENGINE start");
  }
  function pause(){
    if (!timer) return;
    clearInterval(timer);
    timer = null;
    log("ENGINE pause");
  }
  function reset(){
    pause();
    state.tick = 0;
    state.money = START_MONEY;
    state.fuel = 0;
    state.pop = 0;
    state.unlockedFuel = false;
    state.boughtFuel = false;
    state.placedFuel = false;
    state.power = {supply:0,demand:0,state:"RED"};

    state.buildings.clear();
    placeInitial();
    renderAll();
    toast("RESET", "Returned to initial state.", "warn");
    log("RESET complete");
  }

  function stepTick(){
    state.tick++;

    // Demand: Life + Fuel station (if online)
    let demand = 0;
    const life = getB(POS_LIFE.x, POS_LIFE.y);
    const gen  = getB(POS_GEN.x, POS_GEN.y);
    const fuelStation = findFirst("fuel");

    if (life?.online) demand += LIFE_DEMAND;
    if (fuelStation?.online) demand += FUEL_DEMAND;

    // Supply: Generator if online AND has fuel
    let supply = 0;
    if (gen?.online) {
      if (state.fuel > 0) {
        supply += GEN_SUPPLY;
        state.fuel = Math.max(0, state.fuel - GEN_BURN_PER_TICK);
      } else {
        gen.online = false;
        toast("GENERATOR OFFLINE", "Fuel depleted. Restore fuel supply.", "bad");
        log("Generator OFFLINE (fuel depleted)");
      }
    }

    // Power state
    state.power.supply = supply;
    state.power.demand = demand;
    state.power.state = computePowerState(supply, demand);

    // If RED, force dependent systems offline (simple rule)
    if (state.power.state === "RED") {
      if (fuelStation) fuelStation.online = false;
      if (life?.online) {
        life.online = false;
        toast("LIFE SUPPORT OFFLINE", "Insufficient power.", "bad");
        log("Life Support OFFLINE (RED)");
      }
    }

    // Fuel production if fuel station online and not RED
    if (fuelStation?.online && state.power.state !== "RED") {
      state.fuel += FUEL_PROD_PER_TICK;
    }

    // System online condition: generator online + life online + not RED
    const systemOnline = isSystemOnline();

    // First population seed when system comes online
    if (systemOnline && state.pop === 0) {
      state.pop = POP_SEED;
      toast("POPULATION INCREASED", `+${POP_SEED} trust the system.`, "good");
      log(`Population seeded: ${state.pop}`);
    }

    // Taxes only when system online
    if (systemOnline && state.pop > 0) {
      state.money += state.pop * TAX_PER_POP_PER_TICK;
    }

    // Update store glow + buttons
    updateStore();

    renderAll();
  }

  function computePowerState(supply, demand){
    if (demand <= 0) return "GREEN";
    if (supply < demand) return "RED";
    if (supply <= demand * 1.10) return "YELLOW";
    return "GREEN";
  }

  // ====== INTERACTION ======
  function onTileClick(x,y){
    const b = getB(x,y);
    if (!b) return;

    // Toggle generator
    if (b.type === "gen") {
      b.online = !b.online;
      if (b.online) {
        if (state.fuel <= 0) {
          state.fuel = STARTER_FUEL;
          toast("GENERATOR ONLINE", "Starter fuel loaded (fuel is finite).", "cyan");
          log("Generator ONLINE + starter fuel");
        } else {
          toast("GENERATOR ONLINE", "Power supply available.", "good");
          log("Generator ONLINE");
        }
      } else {
        toast("GENERATOR OFFLINE", "Power supply stopped.", "warn");
        log("Generator OFFLINE");
      }
      renderAll();
      return;
    }

    // Toggle life support
    if (b.type === "life") {
      b.online = !b.online;
      if (b.online) {
        toast("LIFE SUPPORT ONLINE", "Stabilization initiated.", "good");
        log("Life Support ONLINE");

        // Unlock store item (this triggers glow)
        if (!state.unlockedFuel) {
          state.unlockedFuel = true;
          toast("STORE UPDATED", "Fuel Station unlocked. Buy it next.", "cyan");
          log("UNLOCK: Fuel Station");
        }
      } else {
        toast("LIFE SUPPORT OFFLINE", "Stabilization interrupted.", "bad");
        log("Life Support OFFLINE");
      }
      updateStore();
      renderAll();
      return;
    }

    // Fuel station (inspect only)
    if (b.type === "fuel") {
      toast("FUEL STATION", b.online ? "ONLINE" : "OFFLINE", "cyan");
    }
  }

  function buyFuel(){
    if (!state.unlockedFuel) return;
    if (state.money < FUEL_STATION_COST) {
      toast("INSUFFICIENT FUNDS", "Taxes accumulate while system is online.", "warn");
      return;
    }
    if (state.boughtFuel) return;

    state.money -= FUEL_STATION_COST;
    state.boughtFuel = true;

    // DEMO ONLY: auto-place it for the player
    if (!getB(POS_FUEL_AUTO.x, POS_FUEL_AUTO.y)) {
      setB(POS_FUEL_AUTO.x, POS_FUEL_AUTO.y, { type:"fuel", name:"Fuel Station", online:true });
      state.placedFuel = true;
      toast("FUEL ONLINE", "Fuel production started.", "good");
      log(`Fuel Station auto-placed at ${POS_FUEL_AUTO.x},${POS_FUEL_AUTO.y}`);
    } else {
      toast("PLACEMENT BLOCKED", "Auto placement tile occupied.", "warn");
      log("WARN: Auto placement blocked");
    }

    updateStore();
    renderAll();
  }

  // ====== STORE ======
  function updateStore(){
    el.storeMoney.textContent = state.money.toFixed(2);

    if (!state.unlockedFuel) {
      el.btnBuyFuel.disabled = true;
      el.btnBuyFuel.textContent = "Locked";
      el.storePanel.classList.remove("glow");
      return;
    }

    const canBuy = state.money >= FUEL_STATION_COST && !state.boughtFuel;
    el.btnBuyFuel.disabled = !canBuy;
    el.btnBuyFuel.textContent = state.boughtFuel ? "Purchased" : "Buy";

    // Glow only when it is the next logical step
    const shouldGlow = state.unlockedFuel && !state.boughtFuel;
    el.storePanel.classList.toggle("glow", shouldGlow);
  }

  // ====== RENDER ======
  function renderAll(){
    renderGrid();
    renderHUD();
    updateStore();
  }

  function renderHUD(){
    el.hudTick.textContent = String(state.tick);

    // System online badge
    const online = isSystemOnline();
    el.hudSystem.textContent = online ? "ONLINE" : "OFFLINE";
    el.hudSystem.className = "pill " + (online ? "good" : "bad");

    // Power badge
    el.hudPowerState.textContent = state.power.state;
    el.hudPowerState.className = "pill " + (state.power.state === "GREEN" ? "good" : state.power.state === "YELLOW" ? "warn" : "bad");
    el.hudPowerNums.textContent = `(${state.power.supply.toFixed(1)} / ${state.power.demand.toFixed(1)})`;

    el.hudPop.textContent = String(state.pop);
    el.hudHappy.textContent = String(state.happy);
    el.hudMoney.textContent = state.money.toFixed(2);
    el.hudFuel.textContent = state.fuel.toFixed(3);

    const life = getB(POS_LIFE.x, POS_LIFE.y);
    el.hudLife.textContent = life?.online ? "ONLINE" : "OFFLINE";
    el.hudLife.className = "pill " + (life?.online ? "good" : "bad");

    const fuel = findFirst("fuel");
    el.hudFuelStation.textContent = fuel?.online ? "ONLINE" : "OFFLINE";
    el.hudFuelStation.className = "pill " + (fuel?.online ? "cyan" : "bad");
  }

  function renderGrid(){
    const tiles = el.grid.querySelectorAll(".tile");
    tiles.forEach(tile => {
      const x = Number(tile.dataset.x), y = Number(tile.dataset.y);
      tile.innerHTML = "";
      tile.classList.toggle("occupied", !!getB(x,y));
      const b = getB(x,y);
      if (b) {
        const badge = document.createElement("div");
        badge.className = "bldg " + (b.online ? "online" : "offline") + " " + (b.type==="fuel" ? "fuel" : b.type==="life" ? "life" : b.type==="gen" ? "gen" : "");
        badge.innerHTML = `<div><div class="name">${labelFor(b)}</div><div class="state">${b.online ? "ONLINE" : "OFFLINE"}</div></div>`;
        tile.appendChild(badge);
      }
    });
  }

  function labelFor(b){
    if (b.type === "gen") return "Generator";
    if (b.type === "life") return "Life Support";
    if (b.type === "fuel") return "Fuel";
    return b.name || "Unit";
  }

  function isSystemOnline(){
    const gen = getB(POS_GEN.x, POS_GEN.y);
    const life = getB(POS_LIFE.x, POS_LIFE.y);
    return !!(gen?.online && life?.online && state.power.state !== "RED");
  }

  // ====== GRID SETUP ======
  function buildGrid(){
    el.grid.innerHTML = "";
    el.grid.style.gridTemplateColumns = `repeat(${GRID_W}, 56px)`;
    el.grid.style.gridTemplateRows = `repeat(${GRID_H}, 56px)`;
    for (let y=0; y<GRID_H; y++){
      for (let x=0; x<GRID_W; x++){
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.dataset.x = String(x);
        tile.dataset.y = String(y);
        tile.addEventListener("click", () => onTileClick(x,y));
        el.grid.appendChild(tile);
      }
    }
  }

  function placeInitial(){
    setB(POS_GEN.x, POS_GEN.y, { type:"gen", name:"Generator", online:false });
    setB(POS_LIFE.x, POS_LIFE.y, { type:"life", name:"Life Support", online:false });
    updateStore();
  }

  // ====== BUILDING MAP ======
  function keyOf(x,y){ return `${x},${y}`; }
  function setB(x,y,b){ state.buildings.set(keyOf(x,y), b); }
  function getB(x,y){ return state.buildings.get(keyOf(x,y)) || null; }
  function findFirst(type){
    for (const b of state.buildings.values()){
      if (b.type === type) return b;
    }
    return null;
  }

  // ====== TOASTS + LOG ======
  function toast(title, body, kind="cyan"){
    const node = document.createElement("div");
    node.className = `toast ${kind}`;
    node.innerHTML = `<div class="t">${esc(title)}</div><div class="b">${esc(body)}</div>`;
    el.toasts.appendChild(node);
    requestAnimationFrame(() => node.classList.add("show"));
    setTimeout(() => {
      node.classList.remove("show");
      setTimeout(() => node.remove(), 180);
    }, 2600);
  }
  function log(msg){
    const now = new Date();
    const stamp = now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    el.log.textContent += `[${stamp}] ${msg}\n`;
    el.log.scrollTop = el.log.scrollHeight;
  }
  function esc(s){
    return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function q(sel){ return document.querySelector(sel); }

  // Start money shown immediately in store
  q("#storeMoney").textContent = state.money.toFixed(2);

  // Wire up buttons
  function wireButtons(){
    q("#btnStart").addEventListener("click", start);
    q("#btnPause").addEventListener("click", pause);
    q("#btnStep").addEventListener("click", stepTick);
    q("#btnReset").addEventListener("click", reset);
  }
  wireButtons();

  // Make sure store reflects initial lock state
  updateStore();
})();
</script>
</body>
</html>
